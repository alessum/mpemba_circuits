name: Run & Commit runnerU1_pure.py

on:
  workflow_dispatch:
    inputs:
      circuit_to_run:
        description: 'Circuit index (integer)'
        required: true
        type: number
      number_of_circuits:
        description: 'How many circuits to run'
        required: false
        default: 10
        type: number
      theta_to_run:
        description: 'Theta to run (float)'
        required: false
        default: 0
        type: number

permissions:
  contents: write   # grant write access to GITHUB_TOKEN

jobs:
  prepare-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Upload U1_theta files
        uses: actions/upload-artifact@v4
        with:
          name: theta-data
          path: data/U1_theta*


  simulate-and-commit:
    needs: prepare-data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (sparse)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            *
            !data/U1_theta*

      - name: Download theta-data artifact
        uses: actions/download-artifact@v4
        with:
          name: theta-data
          path: data/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run runnerU1_pure.py for tot circuits
        run: |
          start=${{ github.event.inputs.circuit_to_run }}
          count=${{ github.event.inputs.number_of_circuits }}
          end=$(( start + count - 1 ))
          echo "Running circuits from $start to $end"
          for i in $(seq $start $end); do
            echo "â†’ Running circuit $i"
            python runnerU1_pure.py --circuit_to_run $i --theta_to_run ${{ github.event.inputs.theta_to_run }}
          done

      - name: Auto-commit changed files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Auto-commit new simulation results'
          file_pattern: 'data/output*'
